
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Mapas | Atlas de Conocimiento Crítico, versión ligera y estática</title>
  <base href="/">
  <meta name="description" content="Atlas de Mapas de Conocimiento Crítico, versión ligera y estática, del programa de Embajadores del Conocimiento (IAAP - Junta de Andalucía)">
  <meta name="keywords" content="static site, conocimiento crítico, gestión del conocimiento, knowledge management, embajadores del conocimiento, ">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="/favicon-atlas.ico">
  
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" 
    integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" 
    crossorigin="anonymous">
  

  <link rel="stylesheet" href="css/leaflet.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/MarkerCluster.Default.css">
  <link rel="stylesheet" href="css/MarkerCluster.css">
  <link rel="stylesheet" href="css/leaflet-search.min.css">
  <link rel="stylesheet" href="css/leaflet-search.mobile.min.css">

  <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.slim.min.js" 
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" 
    crossorigin="anonymous"></script>

  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" 
    integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" 
    crossorigin="anonymous"></script>

  <script type="text/javascript" src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" 
    integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" 
    crossorigin="anonymous"></script>


  <script type="text/javascript" src="js/leaflet.js"></script>

  <script type="text/javascript" src="js/leaflet-wfst.min.js"></script>

  <script type="text/javascript" src="js/leaflet.markercluster.js"></script>

  <script type="text/javascript" src="js/leaflet-search.min.js"></script>


  <script type="text/javascript" src="https://stamen-maps.a.ssl.fastly.net/js/tile.stamen.js?v1.3.0"></script>

  <script type="text/javascript" src="js/Nomenclator.js"></script>

  <script type="text/javascript" src="js/leaflet.LimitZoom.js"></script>

  <script type="text/javascript" src="js/leaflet.ContinuousZoom.js"></script>

  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>

</head>

<body>
    <a href="/sitemap.html"></a>

    
  <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
      <a class="navbar-brand text-light" href="/atlas.html">Atlas de Conocimiento Crítico</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsingNavbar" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
      </button>
      <div div class="collapse navbar-collapse" id="collapsingNavbar">
        <div class="navbar-nav">
          <a class="nav-item nav-link" href="mapas">Mapas</a>
          <a class="nav-item nav-link" href="acerca-de">Acerca de...</a>
          <div id="findbox"></div>
        </div>
      </div>
  </nav>

    
  <div id="map" class="mapstyle"></div>

  <script>
  var app = new Vue({
    el: '#map',
    
    data: {
    },

    mounted: function () {

      var scale_options = {
        position: 'bottomleft',
        maxWidth: 200,
        metric: true,
        imperial: false,
        updateWhenIdle: false 
      }

      var zoom_options = {
        position: 'bottomleft',
        zoomInTitle: 'Ampliar',
        zoomOutTitle: 'Reducir'
      }

      var cluster_options = {
        showCoverageOnHover: false,
      }

      var wfstPointOptions = {
        crs: L.CRS.EPSG4326,
        showExisting: true,
        geometryField: 'geom',
        url: `http://localhost:8080/geoserver/wfs`,
        typeNS: 'test',
        typeName: 'test',
        maxFeatures: 90,
        opacity: 1,
        style: function (layer) {
          // you can use if statemt etc
          return {
            color: 'black',
            weight: 1
          }
        },
      };

      var options = {
        zoom: 8,
        zoomControl: false,
      // Con un nivel 14 minimizaríamos los errores 503 del servidor, pero no los eliminamos (p.e. suroeste de Linares en nivel 15)
        maxZoom: 17,
        minZoom: 5,
        zoomDelta: 0.5,
        zoomSnap: 0.5,
        zooms: [5, 5.5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 9.5, 10, 10.5, 11, 11.5, 12, 12.5, 13, 13.5, 14, 14.5, 15, 15.5, 16, 16.5, 17]
      }

      var map = L.map('map', options ).fitBounds([[34.7711984337,-7.67011449],[39.9592535647,-1.48567791]]);

      //L.Icon.Default.imagePath = 'assets/images';
/*
      // it is required to show attribution to see the map
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
//        attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
*/
      // Grupo de marcadores
      var marker;
      var markers = L.markerClusterGroup( cluster_options );

      // Capas de fondo
      var stamen_layer_watercolor_low = new L.StamenTileLayer("watercolor");
      var stamen_layer_watercolor_high = new L.StamenTileLayer("watercolor");

      // Capas de etiquetas
      var stamen_layer_tonerlines = new L.StamenTileLayer("toner-hybrid");



      
      stamen_layer_watercolor_low.options.maxNativeZoom = 14;
      stamen_layer_watercolor_high.options.maxNativeZoom = 17;


      map.addLayer(stamen_layer_watercolor_low);
      map.addLayer(stamen_layer_watercolor_high);
      map.addLayer(stamen_layer_tonerlines);

      map.addLayer(markers);

      // Si pongo las opciones de búsqueda al principio me da error al buscar (?!)
      var search_options = {
        container: 'findbox',
        layer: markers,
        initial: false,
        collapsed: false,
        textErr: 'No se ha podido encontrar ningún mapa',
        textCancel: 'Cancelar',
        textPlaceholder: 'p.e. Maquetación',
        propertyName: 'title',
        zoom: 16
      }

      var search_control = new L.Control.Search ( search_options );

      var _timeout = 500;
      console.debug ( 'Configuramos retardo a ' + _timeout + 'ms' );

      search_control.on('search:locationfound', function(e) {

      setTimeout ( function() {
        
        console.debug('Introduciendo retardo...');
		
        //console.log('search:locationfound', );

        //map.removeLayer(this._markerSearch)

        if ( ! this.buscando ){
          console.log( 'Buscando: NO?!' );
          this.buscando = true;
        } else {
          console.log( 'Buscando:' + this.buscando );
        }


        if ( e.layer.__parent.spiderfy ) {
          console.log ( 'Cluster?' );
          console.log ( e.layer );
          console.log ( e.layer.__parent );
          e.layer.__parent.spiderfy();
          e.layer.openPopup();
        } else {
          console.log ( 'Marcador?' );
          e.layer.openPopup();
        }
        
        console.log ( 'He encontrado...' );
        console.log ( e );

      }, _timeout );
      }).on('search:collapsed', function(e) {

        console.log ( 'TODO: Mover vista a posición inicial?' );

        if ( this.buscando ){
          this.buscando = false;
          console.log( 'Buscando:' + this.buscando );
        } else {
          console.log( 'No buscando!' );
        }

      });

      // Comprobamos qué evento se dispara el último: zoomend o moveend
      map.on('zoomend', function (e) {
        console.debug('Mapa: zoomend');
      });
      map.on('moveend', function (e) {
        console.debug('Mapa: moveend');
      });
      // Parece que moveend se dispara siempre y además se dispara siempre el último

      map.addControl( search_control ); //inizialize search control

      L.control.scale ( scale_options ).addTo ( map );

      L.control.zoom ( zoom_options ).addTo ( map );
    }
  });
  </script>

    
</body>

</html>
